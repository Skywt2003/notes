# SQL 学习笔记

[toc]

## 基本概念

- **数据库：** 一种专门管理数据的软件。
- **SQL：** Structured Query Language，结构化查询语言，用来访问和操作数据库系统的一种语言。基本所有数据库都支持 SQL。
  - **方言：** 虽然有 SQL 标准，但是不同的数据库有不同版本的 SQL，称为「方言」，其间并不完全兼容。
  - **三种类型操作：**
    - **DDL（Data Definition Language）：** 数据定义（创建表、删除表、修改表结构等）。通常由数据库管理员执行。
    - **DML（Data Manipulation Language）：** 数据维护（添加、删除、更新），一般由应用程序执行。
    - **DQL（Data Query Language）：**数据查询，一般由应用程序执行。
- **语法：** SQL 语言关键字不区分大小写。但是大小写规则非常混乱：针对不同的数据库，对于表名和列名，有的数据库区分大小写，有的数据库不区分大小写。同一个数据库，有的在 Linux 上区分大小写，在 Windows 上不区分大小写。

### MySQL

- MySQL 是目前应用最广泛的开源关系数据库。
- **历史：** MySQL 最早是由瑞典的 MySQL AB 公司开发，该公司在 2008 年被 SUN 公司收购，SUN 公司在 2009 年被 Oracle 公司收购，所以 MySQL 最终就变成了 Oracle 旗下的产品。
- **数据引擎：** MySQL 本身实际上只是一个 SQL 接口，它的内部还包含了多种数据引擎。
  - **InnoDB：** 由 Innobase Oy 公司开发的一款支持事务的数据库引擎，2006 年被 Oracle 收购。
  - **MyISAM：** MySQL 早期集成的默认数据库引擎，不支持事务。
- **衍生版本：**
  - **MariaDB：** MySQL 最早的创始人出走开发了一个分支 MariaDB，使用 XtraDB 引擎。宣称完全兼容 MySQL 且性能更强。
  - ……

## 关系模型

- 关系模型是若干个存储数据的二维表。
- **记录（Record）：** 表的每一行称为记录，记录是一个逻辑意义上的数据。
- **字段（Column）：** 表的每一列称为字段，同一个表的每一行记录都拥有相同的若干字段。字段定义了数据类型、是否允许为`NULL`。
  - `NULL` 表示该字段不存在，并不是为 0 或者空字符串。通常情况下，字段应该避免允许为 `NULL`。不允许为 `NULL` 可以简化查询条件，加快查询速度，也减少判断。

### 主键

- **主键：** 唯一区分不同字段的记录，在同一张表中不允许重复。
  - 主键的作用十分重要，如果修改会引起一系列麻烦。
  - 选取主键的一个基本原则是：不使用任何业务相关的字段作为主键。
- 通常将一个业务无关的字段 `id` 作为主键。
- 常见的主键类型：
  - **自增整数类型：** 数据库会在插入数据时自动为每一条记录分配一个自增整数。
    - 使用 INT 自增类型时，一张表记录数量不能超过 2147483647。使用 BIGINT 自增类型则最多可以存储约 922 亿亿条记录。
  - **全局唯一 GUID 类型：** 使用一种全局唯一的字符串作为主键，类似`8f55d96b-8acc-4636-8cb8-76bf8abc2f57`。GUID 算法通过网卡 MAC 地址、时间戳和随机数保证任意计算机在任意时间生成的字符串都是不同的。大部分编程语言都内置了GUID算法，可以自己预算出主键。
- **联合主键：** 允许多个字段都作为主键，通过多个字段唯一标识记录。
  - 允许一列重复，只要没有两条数据所有主键记录都相同即可。
  - 并不常用，因为会使数据库变复杂。

### 外键

- **外键：** 在一个表中，通过一个字段将记录与另一张表关联起来，这种字段称为外键。

  - 外键可以形成一对多、多对一、多对多关系。
  - 通过定义外键约束，关系数据库可以保证无法插入无效的数据。即如果 `classes` 表不存在 `id=99` 的记录，`students` 表就无法插入 `class_id=99` 的记录。

- **外键约束：** 设置外键约束来定义外键：

  ```sql
  ALTER TABLE students
  ADD CONSTRAINT fk_class_id
  FOREIGN KEY (class_id)
  REFERENCES classes (id);
  ```

  - `fk_class_id` 是外键的名称，可以任意。
  - `FOREIGN KEY (class_id) ` 指定了 `class_id` 作为外键。
  - `REFERENCES classes (id)` 指定了这个外键将关联到 `classes` 表的 `id` 列（即 `classes` 表的主键）。

- **删除外键约束：**

  ```sql
  ALTER TABLE students
  DROP FOREIGN KEY fk_class_id;
  ```

  这个操作不会删除 `fk_class_id` 这个字段，只会删除其作为外键的属性。

- **无约束外键：** 外键约束会降低数据库的性能，所以大部分互联网应用程序为了追求速度，并不设置外键约束，而是仅靠应用程序自身来保证逻辑的正确性。

- **多对多关系：** 通过一个中间表可以实现多对多关系。

- **一对一关系：** 除了特殊的逻辑性用途之外，将一个表拆为多个一对一的表可以增强查询性能。

### 索引

- **索引：** 关系数据库中对某一列或多个列的值进行预排序的数据结构。

  - **优化查询速度：** 通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录。
  - **拖慢更新速度：** 插入、更新和删除记录时，需要同时修改索引，因此，索引越多，修改记录的速度就越慢。
  - **索引效率：** 索引的效率取决于索引列的值是否散列，即该列的值如果越互不相同，那么索引效率越高。如果记录的列存在大量相同的值，例如`gender`列，大约一半的记录值是`M`，另一半是`F`，对该列创建索引就没有意义。
  - **主键索引：** 关系数据库会自动对主键创建主键索引。使用主键索引的效率是最高的，因为主键会保证绝对唯一。

- **创建索引：**

  ```sql
  ALTER TABLE students
  ADD INDEX idx_score (score);
  ```

  - 使用 `ADD INDEX idx_score (score)` 创建一个名称为 `idx_score`，使用列 `score` 的索引。
  - 索引名称是任意的。
  - 创建多列索引： `ADD INDEX idx_name_score (name, score)`。

- **唯一索引：** 对于不允许重复的字段，可以设为唯一索引。

  ```sql
  ALTER TABLE students
  ADD UNIQUE INDEX uni_name (name);
  ```

  通过  `UNIQUE` 关键字创建唯一索引。也可以只添加唯一约束，不创建索引：

  ```sql
  ADD CONSTRAINT uni_name UNIQUE (name);
  ```

## 查询数据

- **基本查询：** `SELECT * FROM <表名>`
  - 查询结果也是一个二维表，它包含列名和每一行的数据。
  - 可以不用 `FROM` 关键字。一般可以用于测试连接。
- **条件查询：** 使用 `WHERE` 关键字。例如 `SELECT * FROM <表明> WHERE <条件表达式>`。
  - 逻辑运算符：`NOT`，`AND`，`OR`。
    - 优先级：`NOT>AND>OR`，可以用小括号调整优先级。
  - 「不等于」表示为 `<>`。
  - 使用 `LIKE` 判断相似：例如 `name LIKE 'ab%'`，`%` 表示任意字符。
- **投影查询：** `SELECT <列1>,<列2> FROM ...` 使结果仅包含指定列。
  - 为列设定别名：`SELECT <列1> <别名1>, <列2> <别名2> FROM ...`，使得结果集中的列名以别名返回。
- **排序：** `ORDER BY` 关键字使返回集针对某个字段排序。
  - 在字段名后加上 `DESC` 使之降序。默认是升序（`ASC` 可以省略）
  - 可以多关键字。
- **分页：**

